<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>4-Page Checkout — Maps + DIGIPIN</title>

  <!-- Tailwind for quick, responsive UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --card:#ffffff; --bg:#f7f7fb; --text:#0f172a; --muted:#6b7280; --accent:#111827; }
    html,body{ height:100%; background:var(--bg); color:var(--text); }
    /* Sticky pin centered overlay */
    .pin {
      position:absolute; left:50%; top:50%; transform:translate(-50%, -100%);
      width:34px; height:34px; pointer-events:none;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.2));
      z-index:10;
    }
    .pin:after{
      content:""; position:absolute; left:50%; top:100%; transform:translateX(-50%);
      width:10px; height:10px; background:rgba(0,0,0,.15); border-radius:50%; filter:blur(2px);
    }
    /* Card */
    .card { background:var(--card); border-radius:1rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.1); }
    /* Hide steps */
    .step{ display:none; }
    .step.active{ display:block; }
    /* Map box height tuned for mobile */
    #map{ width:100%; height:360px; border-radius:.75rem; }
    /* Input look */
    .inp{ width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.875rem 1rem; outline:none; }
    .inp:focus{ border-color:#111827; box-shadow:0 0 0 3px rgba(17,24,39,.1); }
    /* Buttons */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.9rem 1.1rem; border-radius:.9rem; font-weight:600; }
    .btn-primary{ background:var(--accent); color:#fff; }
    .btn-outline{ border:1px solid #e5e7eb; background:#fff; }
    .btn:disabled{ opacity:.6; }
    /* Payment grid */
    .payopt{ border:1px solid #e5e7eb; border-radius:.9rem; padding:1rem; display:flex; gap:.75rem; align-items:flex-start; }
    .payopt input{ margin-top:.2rem; }
  </style>
</head>
<body>
  <main class="max-w-md mx-auto p-4 sm:p-6">
    <!-- Header -->
    <header class="mb-4">
      <div class="text-sm text-gray-500">Step <span id="stepNum">1</span> of 4</div>
      <h1 class="text-2xl font-bold">Checkout</h1>
    </header>

    <!-- Step 1: Location -->
    <section id="step1" class="step active">
      <div class="card p-4 space-y-4">
        <div class="space-y-2">
          <label class="block text-sm font-medium">Search address / place</label>
          <input id="searchInput" class="inp" placeholder="Search for address, area, landmark…" autocomplete="off" />
        </div>

        <div class="relative">
          <div id="map"></div>
          <!-- Sticky center pin -->
          <svg class="pin" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/>
          </svg>
          <div class="absolute left-2 bottom-2 right-2 flex gap-2">
            <button id="btnMyLoc" class="btn btn-outline w-full">Use current location</button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="text-xs text-gray-500 mb-1">Latitude</div>
            <div id="latOut" class="font-mono text-sm">—</div>
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">Longitude</div>
            <div id="lngOut" class="font-mono text-sm">—</div>
          </div>
        </div>

        <div>
          <div class="text-xs text-gray-500 mb-1">DIGIPIN</div>
          <div id="digipinOut" class="font-semibold text-lg tracking-wide">—</div>
        </div>

        <div>
          <div class="text-xs text-gray-500 mb-1">Address</div>
          <div id="addrOut" class="text-sm leading-5">Move the map or search to set your exact spot.</div>
        </div>

        <div class="flex gap-2 pt-2">
          <button id="next1" class="btn btn-primary w-full" disabled>Next</button>
        </div>
      </div>
    </section>

    <!-- Step 2: User details -->
    <section id="step2" class="step">
      <div class="card p-4 space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="text-xs text-gray-500 mb-1">Latitude</div>
            <div id="latOut2" class="font-mono text-sm">—</div>
          </div>
          <div>
            <div class="text-xs text-gray-500 mb-1">Longitude</div>
            <div id="lngOut2" class="font-mono text-sm">—</div>
          </div>
        </div>
        <div>
          <div class="text-xs text-gray-500 mb-1">DIGIPIN</div>
          <div id="digipinOut2" class="font-semibold text-lg tracking-wide">—</div>
        </div>
        <div>
          <div class="text-xs text-gray-500 mb-1">Fetched address</div>
          <div id="addrOut2" class="text-sm leading-5">—</div>
        </div>

        <div class="grid gap-3 pt-2">
          <div>
            <label class="text-sm font-medium">Door / Flat No. (optional)</label>
            <input id="door" class="inp mt-1" placeholder="e.g., 12-B, 2nd floor" />
          </div>
          <div>
            <label class="text-sm font-medium">Full name</label>
            <input id="name" class="inp mt-1" placeholder="Your name" />
          </div>
          <div>
            <label class="text-sm font-medium">Mobile number</label>
            <input id="mobile" class="inp mt-1" placeholder="10-digit mobile" inputmode="numeric" maxlength="10" />
          </div>
        </div>

        <div class="border-t pt-3">
          <div class="text-xs text-gray-500 mb-1">Review</div>
          <div id="reviewBlock" class="text-sm leading-5">
            Fill your details to preview your delivery info here.
          </div>
        </div>

        <div class="flex gap-2 pt-2">
          <button class="btn btn-outline w-1/3" data-prev>Back</button>
          <button id="payNow" class="btn btn-primary w-2/3" disabled>Pay now</button>
        </div>
      </div>
    </section>

    <!-- Step 3: Order + Payment -->
    <section id="step3" class="step">
      <div class="card p-4 space-y-4">
        <h2 class="text-lg font-semibold">Order summary</h2>
        <div id="orderItems" class="text-sm">
          <!-- Demo items; replace with real cart -->
          <div class="flex justify-between"><span>Product A x 1</span><span>₹499</span></div>
          <div class="flex justify-between"><span>Product B x 2</span><span>₹1,198</span></div>
          <div class="flex justify-between text-gray-500"><span>Shipping</span><span>₹0</span></div>
          <div class="flex justify-between font-semibold border-t pt-2"><span>Total</span><span>₹1,697</span></div>
        </div>

        <div class="border-t pt-3">
          <h3 class="text-lg font-semibold mb-1">Deliver to</h3>
          <div id="deliverTo" class="text-sm leading-6">—</div>
        </div>

        <div class="border-t pt-3 space-y-3">
          <h3 class="text-lg font-semibold">Payment options</h3>

          <label class="payopt">
            <input type="radio" name="pay" value="debit_on_pay" checked />
            <div>
              <div class="font-medium">Debit on Pay (UPI Autopay)</div>
              <div class="text-sm text-gray-600">One-time UPI mandate. Money is debited <strong>only at delivery</strong>.</div>
            </div>
          </label>

          <label class="payopt">
            <input type="radio" name="pay" value="upi" />
            <div><div class="font-medium">UPI</div><div class="text-sm text-gray-600">Pay instantly with your UPI app.</div></div>
          </label>

          <label class="payopt">
            <input type="radio" name="pay" value="wallets" />
            <div><div class="font-medium">Wallets</div><div class="text-sm text-gray-600">Popular wallets supported.</div></div>
          </label>

          <label class="payopt">
            <input type="radio" name="pay" value="cards" />
            <div><div class="font-medium">Cards</div><div class="text-sm text-gray-600">Credit / Debit / Prepaid cards.</div></div>
          </label>

          <label class="payopt">
            <input type="radio" name="pay" value="netbanking" />
            <div><div class="font-medium">Netbanking</div><div class="text-sm text-gray-600">Pay via your bank account.</div></div>
          </label>

          <label class="payopt">
            <input type="radio" name="pay" value="cod" />
            <div><div class="font-medium">Cash on Delivery</div><div class="text-sm text-gray-600">Pay in cash when the order arrives.</div></div>
          </label>
        </div>

        <div class="flex gap-2 pt-2">
          <button class="btn btn-outline w-1/3" data-prev>Back</button>
          <button id="confirmPay" class="btn btn-primary w-2/3">Confirm & Pay</button>
        </div>
      </div>
    </section>

    <!-- Step 4: Success -->
    <section id="step4" class="step">
      <div class="card p-6 text-center space-y-4">
        <div class="mx-auto w-16 h-16 rounded-full bg-green-100 flex items-center justify-center">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <path d="M20 6L9 17l-5-5" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h2 class="text-2xl font-semibold">Order placed!</h2>
        <p class="text-gray-600">We’ve sent your order and payment details to your phone/email.</p>
        <div id="successSummary" class="text-sm text-left bg-gray-50 rounded-xl p-3"></div>
        <button class="btn btn-primary w-full" onclick="location.reload()">Back to Home</button>
      </div>
    </section>
  </main>

  <!-- App logic -->
  <script>
    // ===== DIGIPIN function (as provided) =====
    function Get_DIGIPIN(lat, lon) {
      var L=[['F','C','9','8'],['J','3','2','7'],['K','4','5','6'],['L','M','P','T']];
      var vDIGIPIN=''; var row=0, column=0;
      var MinLat=2.5, MaxLat=38.50, MinLon=63.50, MaxLon=99.50;
      var LatDivBy=4, LonDivBy=4, LatDivDeg=0, LonDivDeg=0;
      if(lat<MinLat||lat>MaxLat){ alert('Latitude Out of range'); return ''; }
      if(lon<MinLon||lon>MaxLon){ alert('Longitude Out of range'); return ''; }
      for(let Lvl=1; Lvl<=10; Lvl++){
        LatDivDeg=(MaxLat-MinLat)/LatDivBy;
        LonDivDeg=(MaxLon-MinLon)/LonDivBy;
        var NextLvlMaxLat=MaxLat, NextLvlMinLat=MaxLat-LatDivDeg;
        for(x=0; x<LatDivBy; x++){
          if(lat>=NextLvlMinLat && lat<NextLvlMaxLat){ row=x; break; }
          else{ NextLvlMaxLat=NextLvlMinLat; NextLvlMinLat=NextLvlMaxLat-LatDivDeg; }
        }
        var NextLvlMinLon=MinLon, NextLvlMaxLon=MinLon+LonDivDeg;
        for(x=0; x<LonDivBy; x++){
          if(lon>=NextLvlMinLon && lon<NextLvlMaxLon){ column=x; break; }
          else if((NextLvlMinLon+LonDivDeg)<MaxLon){ NextLvlMinLon=NextLvlMaxLon; NextLvlMaxLon=NextLvlMinLon+LonDivDeg; }
          else{ column=x; }
        }
        if(Lvl==1){ if(L[row][column]=="0"){ vDIGIPIN="Out of Bound"; break; } }
        vDIGIPIN = vDIGIPIN + L[row][column];
        if(Lvl==3 || Lvl==6){ vDIGIPIN = vDIGIPIN + "-"; }
        MinLat=NextLvlMinLat; MaxLat=NextLvlMaxLat;
        MinLon=NextLvlMinLon; MaxLon=NextLvlMaxLon;
      }
      return vDIGIPIN;
    }

    // ===== Simple state =====
    const state = {
      lat: null, lng: null, digipin: '', address: '',
      door:'', name:'', mobile:''
    };

    // ===== Step handling =====
    let currentStep = 1;
    function showStep(n){
      currentStep = n;
      document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
      document.getElementById('step'+n).classList.add('active');
      document.getElementById('stepNum').textContent = n;
      // enable/disable buttons based on data
      if(n===1){ document.getElementById('next1').disabled = !(state.lat && state.lng && state.address && state.digipin); }
      if(n===2){ refreshReview(); }
      if(n===3){ fillDeliverTo(); }
      if(n===4){ fillSuccess(); }
    }
    document.querySelectorAll('[data-prev]').forEach(b=>b.addEventListener('click', ()=>showStep(currentStep-1)));

    // ===== Map + Places + Geocode =====
    let map, geocoder, autocomplete;
    let isMapReady = false;
    let reverseGeoTimer;

    function initMap(){
      geocoder = new google.maps.Geocoder();

      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 17.385, lng: 78.486}, // Hyderabad default
        zoom: 16, disableDefaultUI: true, gestureHandling: "greedy"
      });
      isMapReady = true;

      // Places Autocomplete
      const input = document.getElementById('searchInput');
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ['geometry', 'formatted_address', 'name'],
        componentRestrictions: {country: ['in']}
      });
      autocomplete.addListener('place_changed', ()=>{
        const place = autocomplete.getPlace();
        if(place.geometry && place.geometry.location){
          map.panTo(place.geometry.location);
          map.setZoom(17);
        }
      });

      // Sticky pin behavior: on map idle, read center and update
      map.addListener('idle', ()=>{
        const c = map.getCenter();
        if(!c) return;
        const lat = +c.lat().toFixed(6);
        const lng = +c.lng().toFixed(6);
        updateLocation(lat, lng);
      });

      // Try geolocation once on load (optional)
      tryLocate();
    }

    function tryLocate(){
      const btn = document.getElementById('btnMyLoc');
      btn.addEventListener('click', () => {
        if(!navigator.geolocation){
          alert('Geolocation not supported on this device/browser.');
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            const {latitude, longitude} = pos.coords;
            map.panTo({lat: latitude, lng: longitude});
            map.setZoom(17);
          },
          (err)=>{
            alert('Could not get location: ' + (err && err.message ? err.message : 'Permission denied or unavailable.'));
          },
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      });

      // Auto locate once (non-blocking)
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            const {latitude, longitude} = pos.coords;
            map.setCenter({lat: latitude, lng: longitude});
            map.setZoom(17);
          },
          ()=>{/* ignore */},
          { enableHighAccuracy:true, timeout:5000, maximumAge:0 }
        );
      }
    }

    // Debounced reverse geocode & DIGIPIN calculation
    function updateLocation(lat, lng){
      state.lat = lat; state.lng = lng;
      document.getElementById('latOut').textContent = lat;
      document.getElementById('lngOut').textContent = lng;

      // Compute DIGIPIN (only valid inside defined bounds)
      try {
        const pin = Get_DIGIPIN(lat, lng) || '';
        state.digipin = pin;
        document.getElementById('digipinOut').textContent = pin || 'Out of Bound';
      } catch(e){
        state.digipin = '';
        document.getElementById('digipinOut').textContent = '—';
      }

      // Debounce reverse geocode
      clearTimeout(reverseGeoTimer);
      reverseGeoTimer = setTimeout(()=> doReverseGeocode(lat, lng), 250);
    }

    function doReverseGeocode(lat, lng){
      if(!geocoder) return;
      geocoder.geocode({ location: {lat, lng} }, (results, status)=>{
        let addrText = '';
        if(status === 'OK' && results && results.length){
          addrText = results[0].formatted_address || results[0].name || '';
        } else {
          addrText = 'Address not found for this spot. You can still continue.';
        }
        state.address = addrText;
        document.getElementById('addrOut').textContent = addrText || '—';
        document.getElementById('next1').disabled = !(state.lat && state.lng && state.address && state.digipin);
      });
    }

    // ===== Step 1 -> 2 =====
    document.getElementById('next1').addEventListener('click', ()=>{
      // Mirror data into Step 2
      document.getElementById('latOut2').textContent = state.lat ?? '—';
      document.getElementById('lngOut2').textContent = state.lng ?? '—';
      document.getElementById('digipinOut2').textContent = state.digipin || '—';
      document.getElementById('addrOut2').textContent = state.address || '—';
      showStep(2);
    });

    // ===== Step 2: live review & validation =====
    ['door','name','mobile'].forEach(id=>{
      document.getElementById(id).addEventListener('input', (e)=>{
        state[id] = e.target.value.trim();
        refreshReview();
      });
    });

    function isValidMobile(m){
      return /^[6-9]\d{9}$/.test(m);
    }

    function refreshReview(){
      const door = state.door ? state.door + ', ' : '';
      const fullAddr = door + (state.address || '');
      const review = `
        <div><span class="text-gray-500">Name:</span> <strong>${state.name || '—'}</strong></div>
        <div><span class="text-gray-500">Mobile:</span> <strong>${state.mobile || '—'}</strong></div>
        <div class="mt-1"><span class="text-gray-500">Address:</span> <strong>${fullAddr || '—'}</strong></div>
        <div class="mt-1 text-gray-500">DIGIPIN: <span class="font-mono text-gray-800">${state.digipin || '—'}</span></div>
        <div class="text-gray-500">Coords: <span class="font-mono text-gray-800">${state.lat ?? '—'}, ${state.lng ?? '—'}</span></div>
      `;
      document.getElementById('reviewBlock').innerHTML = review;

      // Enable Pay now if name + valid mobile present
      const canPay = (state.name && isValidMobile(state.mobile));
      document.getElementById('payNow').disabled = !canPay;
    }

    // Step 2 -> 3
    document.getElementById('payNow').addEventListener('click', ()=>{
      fillDeliverTo();
      showStep(3);
    });

    // ===== Step 3: deliver-to summary =====
    function fillDeliverTo(){
      const door = state.door ? state.door + ', ' : '';
      const fullAddr = door + (state.address || '');
      const html = `
        <div class="font-medium">${state.name} • ${state.mobile}</div>
        <div>${fullAddr}</div>
        <div class="text-gray-500 mt-1">DIGIPIN <span class="font-mono">${state.digipin}</span></div>
        <div class="text-gray-500">Lat/Lng <span class="font-mono">${state.lat}, ${state.lng}</span></div>
      `;
      document.getElementById('deliverTo').innerHTML = html;
    }

    // Step 3 -> 4
    document.getElementById('confirmPay').addEventListener('click', ()=>{
      // Normally trigger gateway here based on selected option
      // For demo, proceed to success
      showStep(4);
    });

    // ===== Step 4: success details =====
    function fillSuccess(){
      const pay = (document.querySelector('input[name="pay"]:checked')||{}).value || 'debit_on_pay';
      const payLabel = {
        debit_on_pay:'Debit on Pay (UPI Autopay)',
        upi:'UPI', wallets:'Wallets', cards:'Cards', netbanking:'Netbanking', cod:'Cash on Delivery'
      }[pay] || 'Payment';

      const door = state.door ? state.door + ', ' : '';
      const fullAddr = door + (state.address || '');
      const html = `
        <div class="space-y-1">
          <div><span class="text-gray-500">Payment:</span> <strong>${payLabel}</strong></div>
          <div><span class="text-gray-500">Name:</span> <strong>${state.name}</strong></div>
          <div><span class="text-gray-500">Mobile:</span> <strong>${state.mobile}</strong></div>
          <div><span class="text-gray-500">Address:</span> <strong>${fullAddr}</strong></div>
          <div><span class="text-gray-500">DIGIPIN:</span> <span class="font-mono">${state.digipin}</span></div>
          <div><span class="text-gray-500">Coords:</span> <span class="font-mono">${state.lat}, ${state.lng}</span></div>
        </div>
      `;
      document.getElementById('successSummary').innerHTML = html;
    }

    // ===== Init after Maps script is loaded =====
    window.initMap = initMap;
  </script>

  <!-- Load Google Maps JS API (Maps + Places). Replace YOUR_GOOGLE_MAPS_API_KEY -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDN3L9gYsZpD2_BYRfElnPbRPVQb6sPufg&libraries=places&callback=initMap">
  </script>

  <!-- Notes:
    * Serve over HTTPS. If embedding in an iframe, ensure the parent does NOT block geolocation via Permissions-Policy.
    * If geolocation permission is denied, users can still set the location by searching or moving the map.
    * The map’s center acts as the “sticky pin.” Panning/zooming updates coordinates, DIGIPIN, and address automatically.
  -->
</body>
</html>
